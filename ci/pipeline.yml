---
resource_types    :
  - name          : pull-request
    type          : docker-image
    source        :
      repository  : jtarchie/pr

  - name          : slack-notification
    type          : docker-image
    source        :
      repository  : quay.io/hellofresh/slack-notification-resource

  - name          : hf-github-releases
    type          : docker-image
    source        :
      repository  : quay.io/hellofresh/gh-status-dynamic

###############################
# Resources
###############################
resources:
- name: api-gateway
  type: git
  source:
    uri: {{uri}}
    access_token: {{oauth_token}}
    branch: master

- name          : prequest
  type          : pull-request
  source        :
    uri         : {{uri}}
    access_token: {{oauth_token}}
    repo        : hellofresh/api-gateway

- name          : gh-release-rc
  type          : hf-github-releases
  source        :
    user        : "hellofresh"
    repository  : "api-gateway"
    access_token: {{oauth_token}}
    pre_release : true

- name              : semantic-rc-version
  type              : semver
  source            :
    driver          : git
    initial_version : 0.0.0-rc.1
    uri             : {{uri}}
    branch          : version
    file            : version

- name              : automation-release
  type              : github-release
  source            :
    user            : hellofresh
    repository      : automation
    access_token    : {{oauth_token}}

- name              : slack-alert
  type              : slack-notification
  source            :
    url             : {{slack_url}}

###############################
# Groups
###############################
groups:
- name: All
  jobs:
    - master-test-suite
    - build and release
    - pullrequest
    - deploy-to-staging

- name: Pullrequest
  jobs:
    - pullrequest

- name: Master
  jobs:
    - master-test-suite
    - build and release
    - deploy-to-staging

###############################
# Jobs
###############################
jobs:

#
# Merge to master
#
- name: master-test-suite
  plan:
  - get: api-gateway
    trigger: true

  - aggregate:
    - task: master unit test
      config:
        platform: linux
        image_resource:
          type: docker-image
          source: 
              repository: quay.io/hellofresh/api-gateway
              username: {{quay_username}}
              password: {{quay_password}}
        run:
          path: api-gateway/ci/tasks/unit-tests.sh
        inputs:
        - name: api-gateway
      params:
        PROJECT_SRC: {{project_src}}

- name: build and release
  public: false
  serial: true
  plan:
  - get: api-gateway
    trigger: true
    passed: ["master-test-suite"]

  - task: build go app
    config:
        platform: linux
        image_resource:
          type: docker-image
          source: 
              repository: quay.io/hellofresh/api-gateway
              username: {{quay_username}}
              password: {{quay_password}}
        run:
          path: ./api-gateway/ci/tasks/build.sh
        inputs:
        - name: api-gateway
        outputs:
        - name: artifacts
        params:
          PROJECT_SRC: {{project_src}}

  - put: semantic-rc-version
    params:
        pre: 'rc'

  - put: gh-release-rc
    params:
      name: semantic-rc-version/version
      tag : semantic-rc-version/version
      globs:
      - artifacts/*.tar.gz

- name: deploy-to-staging
  public: false
  serial: true
  plan:
  - get: gh-release-rc
    trigger: true
    passed: ["build and release"]
  - get: api-gateway
    trigger: false
  - get: automation-release
    trigger: false
  - task: deploy to staging
    file: api-gateway/ci/tasks/deploy-staging.yml
    on_failure:
        put: slack-alert
        params:
          channel: '#deployments'
          text: |
              The build for api-gateway failed. Check it out at:
              http://ci000.tools.hellofresh.io:8080/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
              or at:
              http://ci000.tools.hellofresh.io:8080/builds/$BUILD_ID
    on_success:
        put: slack-alert
        params:
          channel: '#deployments'
          text: |
              The build for the api-gateway was successful. Check it out at:
              http://ci000.tools.hellofresh.io:8080/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
              or at:
              http://ci000.tools.hellofresh.io:8080/builds/$BUILD_ID
    params:
      INPUT: automation-release
      ANSIBLE_REMOTE_USER: jenkins
      VPASS: {{vpass}}
      PRIVATE_KEY: {{private_key}}
      ANSIBLE_PRIVATE_KEY_FILE: /root/.ssh/ansible_id_rsa
      TAR_FILE: automation-release/automation-artifcat.tar.gz
      CI_INVENTORY: "staging.ini"
      GROUP_NAME: "ops-gateway"
      VERSION_FILE: 'gh-release-rc/version'

#
# PR
#
- name: pullrequest
  plan: 
  - get: prequest
    trigger: true

  - put: prequest
    params:
        path: {{project_src}}
        context: unit-tests
        status: pending

  - aggregate:
    - task: pullrequest unit test
      file: api-gateway/ci/tasks/prequest-unit-tests.yml
      on_failure:
          put: prequest
          params:
              path: {{project_src}}
              context: unit-tests
              status: failure
      on_success:
          put: prequest
          params:
              path: {{project_src}}
              context: unit-tests
              status: success

